<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clasificador de Aves</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      body {
        background: #e0e8ff;
      }

      #resultado {
        font-weight: bold;
        font-size: 2.8rem;
        text-align: center;
      }

      .btn-camara {
        background-color: #9a6bcd;  
        border-color: #9a6bcd;
        color: white;
        font-weight: bold;
      }
      .btn-camara:hover {
        background-color: #bb84f5;
        border-color: #bb84f5;
      }

      .caja-cam {
        border: 3px solid #8d70b5;
        border-radius: 10px;
        padding: 8px;
        background: white;
      }
    </style>
  </head>
  <body>
    
    <main>
      <div class="px-4 py-3 text-center border-bottom" style="background-color: #c5d3ff;">
        <h1 class="display-5 titulo" style="color:#37125c;">Clasificador de Aves</h1>
        <div class="col-lg-6 mx-auto">
          <p class="lead">Clasificaci&oacute;n de aves usando la c&aacute;mara web utilizando Tensorflow.js</p>
        </div>
      </div>

      <div class="container mt-4">
        <div class="row justify-content-center">
          <div class="col-12 col-md-5 text-center">

            <video id="video" playsinline autoplay muted style="width: 1px;"></video>

            <button class="btn btn-camara mb-2" id="cambiar-camara" onclick="cambiarCamara();">
              Cambiar cámara
            </button>

            <div class="caja-cam">
              <canvas id="canvas" width="300" height="300" style="max-width: 100%;"></canvas>
              <canvas id="precanvas" width="160" height="160" style="display:none"></canvas>
            </div>

            <div id="resultado" class="mt-3">...</div>

          </div>
        </div>
      </div>

      <div class="text-secondary mt-5 px-4 py-2 text-center" style="background-color: #340a52;">
        <div class="py-4">
          <div class="col-lg-6 mx-auto text-white">
            <p class="fs-5 mb-4">Licenciatura en Ciencias de la Computación</p>
            <p class="fs-5">Redes Neuronales 2025-2</p>
            <p class="fs-5 mb-4">Georgina Salcido Valenzuela - 222211198</p>
          </div>
        </div>
      </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>

<script>
  let video = document.getElementById("video");
  let canvas = document.getElementById("canvas");
  let precanvas = document.getElementById("precanvas");
  let ctx = canvas.getContext("2d");

  let currentStream = null;
  let facingMode = "user";

  let modelo = null;
  let CLASES = [];

  // === Cargar clases ===
  async function cargarClases() {
    const res = await fetch("clases_aves.txt");
    const texto = await res.text();
    return texto.trim().split("\n");
  }

  // === Cargar modelo y clases ===
  (async () => {
    console.log("Cargando clases y modelo...");

    CLASES = await cargarClases();
    console.log("Clases cargadas:", CLASES.length);

    modelo = await tf.loadLayersModel("model/model.json");
    console.log("Modelo cargado.");
  })();

  // === Activar cámara ===
  window.onload = function() {
    mostrarCamara();
  };

  // function mostrarCamara() {
  //   let opciones = {
  //     audio: false,
  //     video: { width: 300, height: 300 }
  //   };

  //   navigator.mediaDevices.getUserMedia(opciones)
  //     .then(function(stream) {
  //       currentStream = stream;
  //       video.srcObject = currentStream;
  //       procesarCamara();
  //       predecir();
  //     })
  //     .catch(err => {
  //       alert("No se pudo acceder a la cámara");
  //       console.error(err);
  //     });
  // }

  async function mostrarCamara() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facingMode, width: 300, height: 300 },
        audio: false
      });

      video.srcObject = stream;
      currentStream = stream;

      procesarCamara();
      predecir();
    } catch (err) {
      console.error("ERROR CAMARA:", err);
      alert("El navegador del celular está bloqueando la cámara. Usa Chrome y revisa permisos.");
    }
  }

  function cambiarCamara() {
    if (currentStream) {
      currentStream.getTracks().forEach(t => t.stop());
    }

    facingMode = (facingMode === "user") ? "environment" : "user";

    let opciones = {
      audio: false,
      video: {
        facingMode: facingMode,
        width: 300,
        height: 300
      }
    };

    navigator.mediaDevices.getUserMedia(opciones)
      .then(stream => {
        currentStream = stream;
        video.srcObject = currentStream;
      })
      .catch(err => console.error(err));
  }

  // === Dibujar cámara en canvas ===
  function procesarCamara() {
    ctx.drawImage(video, 0, 0, 300, 300);
    setTimeout(procesarCamara, 20);
  }

  // === Redimensionar a 100x100 ===
  function redimensionar() {
    let ctx2 = precanvas.getContext("2d");
    ctx2.drawImage(canvas, 0, 0, 300, 300, 0, 0, 160, 160);
  }

  // === Predicción ===
  function predecir() {
    if (modelo) {

      redimensionar();

      let ctx2 = precanvas.getContext("2d");
      let imgData = ctx2.getImageData(0,0,160,160);

      let arr = [];
      let fila = [];

      for (let i = 0; i < imgData.data.length; i += 4) {
          let r = imgData.data[i] / 255;
          let g = imgData.data[i + 1] / 255;
          let b = imgData.data[i + 2] / 255;

          fila.push([r, g, b]);

          if (fila.length === 160) {
              arr.push(fila);
              fila = [];
          }
      }

      let tensor = tf.tensor4d([arr], [1,160,160,3]);

      let pred = modelo.predict(tensor).dataSync();
      let indice = pred.indexOf(Math.max(...pred));
      let clase = CLASES[indice];

      document.getElementById("resultado").innerHTML = clase;
    }

    setTimeout(predecir, 200);
  }
</script>

  </body>
</html>
